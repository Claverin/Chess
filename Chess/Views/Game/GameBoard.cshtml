@using Chess.Domain.Entities
@model Game

@{
    ViewData["Title"] = "Chess Application";
    ViewBag.BodyClass = "page-game";
}

@section Styles {
    <link rel="stylesheet" href="~/css/gameBoard.css" asp-append-version="true" />
}

<div class="container mt-4">
    @if (!Model.IsGameActive && Model.IsCheckmate)
    {
        <div class="alert alert-danger text-center">
            Checkmate! Player @Model.Winner?.Colour wins!
        </div>
    }
    else if (!Model.IsGameActive && Model.IsStalemate)
    {
        <div class="alert alert-warning text-center">
            Stalemate! The game is a draw.
        </div>
    }
    else if (Model.IsCheck)
    {
        <div class="alert alert-info text-center">Check!</div>
    }

    <div class="chess-board @(Model.IsGameActive ? "" : "game-ended")">
        @foreach (var cell in Model.Board.Cells)
        {
            var piece = cell.Piece;
            var isPlayersPiece = Model.IsGameActive && piece?.Color == Model.CurrentPlayerColor;
            var canSelect = isPlayersPiece && (piece?.HasAnyLegalMove ?? false);

            var cellClasses = canSelect ? "cell active-piece" : "cell";
            if (cell.IsHighlighted) cellClasses += " highlighted";

            <div class="@cellClasses"
                 style="@(string.IsNullOrWhiteSpace(cell.FieldColor) ? null : $"background-color:{cell.FieldColor};")"
                 data-x="@cell.Field.X" data-y="@cell.Field.Y">

                @if (Model.DebugMode)
                {
                    <div class="debug-coords">x=@cell.Field.X y=@cell.Field.Y</div>
                }

                @* Ruch na podświetlone pole (POST) *@
                @if (Model.IsGameActive && cell.IsHighlighted)
                {
                    <form asp-controller="Game" asp-action="MovePieceTo" method="post" class="move-form">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="x" value="@cell.Field.X" />
                        <input type="hidden" name="y" value="@cell.Field.Y" />
                        <button type="submit" class="move-btn" aria-label="Move here"></button>
                    </form>
                }

                @* Figura *@
                @if (piece != null)
                {
                    if (canSelect)
                    {
                        <form asp-controller="Game" asp-action="SelectPiece" method="post" class="piece-form">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="pieceId" value="@piece.Id" />
                            <button type="submit" class="piece-btn" aria-label="Select piece">
                                <img class="piece-img" src="@piece.Image" draggable="false" />
                            </button>
                        </form>
                    }
                    else
                    {
                        <img class="piece-img" src="@piece.Image" draggable="false" />
                    }

                    @if (Model.DebugMode)
                    {
                        <div class="debug-id">
                            ID: @piece.Id |
                            OnMove: @(piece.HasAnyLegalMove ? "T" : "F")
                        </div>
                    }
                }
            </div>
        }
    </div>

    <div class="text-center mt-4 text-light">
        <div><strong>Move:</strong> @Model.CurrentPlayerColor</div>
        <div><strong>White Score:</strong> @Model.Players[0].Score</div>
        <div><strong>Black Score:</strong> @Model.Players[1].Score</div>
        <div><strong>Number of Players:</strong> @Model.NumberOfPlayers</div>
        @if (!Model.IsGameActive && Model.Winner != null)
        {
            <div><strong>Winner:</strong> @Model.Winner.Colour</div>
        }
    </div>
</div>
